{
    "Solution" : {
        "Id" : "{{cookiecutter.solution_id}}",
        "Name" : "{{cookiecutter.solution_name}}"
    },
    "Tiers" : {
        "web" : {
            "Components" : {
                "static" : {
                    "S3" : {
                        "Instances" : {
                            "default" : { 
                                "Versions" : {
                                    "v1" : {
                                        "DeploymentUnits" : ["static-v1"]
                                    }
                                }
                            }
                        },
                        "Website" : {
                            "Enabled" : true
                        },
                        "PublicAccess" : {
                            "GlobalReadOnly" : {
                                "Enabled" : true,
                                "Permissions" : "ro",
                                "IPAddressGroups" : {{ cookiecutter.source_ip.split(",") | tojson}},
                                "Paths" : {{ cookiecutter.global_media_paths.split(",") | tojson }}
                            }
                        },
                        "CORSBehaviours" : [ "S3Read" ] 
                    }
                }
            }
        },
        "frontdoor" : {
            "Components" : {
                "www-lb" : {
                    "LB" : {
                        "Instances" : {
                            "default" : {
                                "Versions" : {
                                    "v1" : {
                                        "DeploymentUnits" : ["frontdoor-v1-lb"]
                                    }
                                }
                            }
                        },
                        "Engine" : "application",
                        "Logs" : true,
                        "PortMappings" : {
                            "httpsflower" : {
                                "Priority" : 200,
                                "HostFilter" : true,
                            },
                            "https" : {
                                "Priority" : 500,
                                "HostFilter" : true
                            },
                            "httpredirect" : {
                                "Redirect" : {}
                            }
                        },
                        "IPAddressGroups" : {{ cookiecutter.source_ip.split(",") | tojson}}
                    }
                }
            }
        },
        "app" : {
            "Components" : {
                "app-ecs" : {
                    "DeploymentUnits" : ["app-ecs"],
                    "ECS" : {
                        "Containers" : {
                            "Configuration" : {
                                "Links" : {
                                    "database" : {
                                        "Tier" : "db",
                                        "Component" : "database"
                                    },
                                    "cache" : {
                                        "Tier" : "db",
                                        "Component" : "cache"
                                    },
                                    "DJANGO_AWS_STORAGE_BUCKET" : {
                                        "Tier" : "web",
                                        "Component" : "static",
                                        "Role" : "all"
                                    }
                                }
                            }
                        },
                        "Services" : {
                            "www-web" : {
                                "Instances" : {
                                    "default" : {
                                        "Versions" : {
                                            "v1" : {
                                                "DeploymentUnits" : ["www-v1-web"]
                                            }
                                        }
                                    }
                                },
                                "Containers" : {
                                    "www-web" : {
                                        "Cpu" : 512,
                                        "Memory" : 512,
                                        "Ports" : {
                                            "http" : {
                                                "LB" : {
                                                    "Tier": "elb",
                                                    "Component"  : "frontdoor",
                                                    "PortMapping" : "https",
                                                    "LinkName" : "SITE"
                                                },
                                                "DynamicHostPort" : true
                                            }
                                        }
                                    }
                                }
                            },
                            "www-celeryworker" : {
                                "Instances" : {
                                    "default" : {
                                        "Versions" : {
                                            "v1" : {
                                                "DeploymentUnits" : ["www-v1-celeryworker"]
                                            }
                                        }
                                    }
                                },
                                "Containers" : {
                                    "www-celeryworker" : {
                                        "Cpu" : 512,
                                        "Memory" : 512
                                    }
                                }
                            },
                            "www-celerybeat" : {
                                "Instances" : {
                                    "default" : {
                                        "Versions" : {
                                            "v1" : {
                                                "DeploymentUnits" : ["www-v1-celerybeat"]
                                            }
                                        }
                                    }
                                },
                                "DesiredCount" : 1,
                                "Containers" : {
                                    "www-celerybeat" : {
                                        "Cpu" : 256,
                                        "Memory" : 256,
                                        "MaximumMemory" : -1
                                    }
                                }
                            },
                            "www-flower" : {
                                "Instances" : {
                                    "default" : {
                                        "Versions" : {
                                            "v1" : {
                                                "DeploymentUnits" : ["www-v1-flower"]
                                            }
                                        }
                                    }
                                },
                                "DesiredCount" : 1,
                                "Containers" : {
                                    "www-flower" : {
                                        "Cpu" : 128,
                                        "Memory" : 128,
                                        "Ports" : {
                                            "flower" : {
                                                "LB" : {
                                                    "Tier": "elb",
                                                    "Component"  : "frontdoor",
                                                    "PortMapping" : "httpsflower",
                                                    "LinkName" : "CELERY_FLOWER_LB"
                                                },
                                                "DynamicHostPort" : true
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        "Tasks" : {
                            "www-task" : {
                                "Instances" : {
                                    "default" : {
                                        "Versions" : {
                                            "v1" : {
                                                "DeploymentUnits" : ["www-v1-task"]
                                            }
                                        }
                                    }
                                },
                                "Containers" : {
                                    "www-task" : {
                                        "Cpu" : 512,
                                        "Memory" : 512,
                                        "Links" : {
                                            "database" : {
                                                "Tier" : "db",
                                                "Component" : "database"
                                            },
                                            "cache" : {
                                                "Tier" : "db",
                                                "Component" : "cache"
                                            },
                                            "DJANGO_AWS_STORAGE_BUCKET" : {
                                                "Tier" : "web",
                                                "Component" : "static",
                                                "Role" : "all"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "msg" : {
            "Components" : {
                "queue" : {
                    "cache" : {
                        "Instances" : {
                            "default" : {
                                "Versions" : {
                                    "v1" : {
                                        "DeploymentUnits" : ["queue-v1-redis"]
                                    }
                                }
                            }
                        },
                        "Engine" : "redis"
                    }
                }
            }
        },
        "db" :{
            "Components" : {
                "database" : {
                    "RDS" : {
                        "Instances" : {
                            "default" : {
                                "Versions" : {
                                    "v1" : {
                                        "DeploymentUnits" : ["database-v1-rds"]
                                    }
                                }
                            }
                        },
                        "Engine" : "postgres",
                        "GenerateCredentials" : {
                            "Enabled" : true,
                            "EncryptionScheme" : "base64"
                        },
                        "Size" : {{ cookiecutter.database_size_gb }}
                    }
                }
            }
        }
    }
}
